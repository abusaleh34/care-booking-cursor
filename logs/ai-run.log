
> care-services-backend@1.0.0 test
> vitest run --coverage --run || true

[33mThe CJS build of Vite's Node API is deprecated. See https://vite.dev/guide/troubleshooting.html#vite-cjs-node-api-deprecated for more details.[39m

 RUN  v1.5.0 /Users/ibrahimalmotairi/projects/care-services-cursor
      Coverage enabled with v8

 â¯ tests/unit/customer/search-filters.spec.ts  (0 test)
 â¯ tests/unit/customer/search.service.spec.ts  (0 test)
 â¯ tests/unit/customer/booking-lifecycle.spec.ts  (0 test)
 â¯ tests/unit/auth/audit.service.spec.ts  (0 test)
 â¯ tests/unit/auth/auth.controller.spec.ts  (0 test)
 â¯ tests/unit/customer/payment-processing.spec.ts  (0 test)
 â¯ tests/unit/auth/auth-jwt-mfa.spec.ts  (0 test)
 â¯ tests/unit/auth/token.service.spec.ts  (0 test)
 â¯ tests/unit/auth/sms.service.spec.ts  (0 test)
 â¯ tests/unit/auth/email.service.spec.ts  (22 tests | 22 failed) 20ms
   â¯ tests/unit/auth/email.service.spec.ts > EmailService > constructor > should create nodemailer transporter with correct config
     â†’ Cannot read properties of undefined (reading 'get')
   â¯ tests/unit/auth/email.service.spec.ts > EmailService > sendVerificationEmail > should send verification email with correct parameters
     â†’ Cannot read properties of undefined (reading 'get')
   â¯ tests/unit/auth/email.service.spec.ts > EmailService > sendVerificationEmail > should handle email sending errors
     â†’ Cannot read properties of undefined (reading 'get')
   â¯ tests/unit/auth/email.service.spec.ts > EmailService > sendPasswordResetEmail > should send password reset email with correct parameters
     â†’ Cannot read properties of undefined (reading 'get')
   â¯ tests/unit/auth/email.service.spec.ts > EmailService > sendWelcomeEmail > should send welcome email for customers
     â†’ Cannot read properties of undefined (reading 'get')
   â¯ tests/unit/auth/email.service.spec.ts > EmailService > sendWelcomeEmail > should send welcome email for providers
     â†’ Cannot read properties of undefined (reading 'get')
   â¯ tests/unit/auth/email.service.spec.ts > EmailService > sendWelcomeEmail > should send generic welcome for unknown role
     â†’ Cannot read properties of undefined (reading 'get')
   â¯ tests/unit/auth/email.service.spec.ts > EmailService > sendBookingConfirmation > should send booking confirmation to customer
     â†’ Cannot read properties of undefined (reading 'get')
   â¯ tests/unit/auth/email.service.spec.ts > EmailService > sendBookingConfirmation > should send booking notification to provider
     â†’ Cannot read properties of undefined (reading 'get')
   â¯ tests/unit/auth/email.service.spec.ts > EmailService > sendBookingCancellation > should send cancellation email to customer
     â†’ Cannot read properties of undefined (reading 'get')
   â¯ tests/unit/auth/email.service.spec.ts > EmailService > sendBookingCancellation > should send cancellation email to provider
     â†’ Cannot read properties of undefined (reading 'get')
   â¯ tests/unit/auth/email.service.spec.ts > EmailService > sendBookingReminder > should send reminder email with correct details
     â†’ Cannot read properties of undefined (reading 'get')
   â¯ tests/unit/auth/email.service.spec.ts > EmailService > sendPaymentReceipt > should send payment receipt email
     â†’ Cannot read properties of undefined (reading 'get')
   â¯ tests/unit/auth/email.service.spec.ts > EmailService > sendAccountLockNotification > should send account lock notification
     â†’ Cannot read properties of undefined (reading 'get')
   â¯ tests/unit/auth/email.service.spec.ts > EmailService > sendAccountUnlockNotification > should send account unlock notification
     â†’ Cannot read properties of undefined (reading 'get')
   â¯ tests/unit/auth/email.service.spec.ts > EmailService > sendReviewRequest > should send review request email
     â†’ Cannot read properties of undefined (reading 'get')
   â¯ tests/unit/auth/email.service.spec.ts > EmailService > sendProviderApprovalNotification > should send approval notification
     â†’ Cannot read properties of undefined (reading 'get')
   â¯ tests/unit/auth/email.service.spec.ts > EmailService > sendProviderApprovalNotification > should send rejection notification
     â†’ Cannot read properties of undefined (reading 'get')
   â¯ tests/unit/auth/email.service.spec.ts > EmailService > sendCustomEmail > should send custom email with provided content
     â†’ Cannot read properties of undefined (reading 'get')
   â¯ tests/unit/auth/email.service.spec.ts > EmailService > sendCustomEmail > should generate text from HTML if not provided
     â†’ Cannot read properties of undefined (reading 'get')
   â¯ tests/unit/auth/email.service.spec.ts > EmailService > error handling > should propagate transporter errors
     â†’ Cannot read properties of undefined (reading 'get')
   â¯ tests/unit/auth/email.service.spec.ts > EmailService > error handling > should handle missing email configuration gracefully
     â†’ Cannot read properties of undefined (reading 'get')
 â¯ tests/unit/provider/provider-booking.service.spec.ts  (0 test)
 â¯ tests/e2e/customer-journey.spec.ts  (0 test)
 â¯ src/customer/services/booking.service.spec.ts  (0 test)
 â¯ tests/unit/auth/auth-registration.spec.ts  (0 test)
 â¯ src/admin/services/admin-user-management.service.spec.ts  (0 test)
 â¯ src/auth/services/auth.service.spec.ts  (0 test)
 â¯ src/auth/services/password.service.spec.ts  (0 test)
 â¯ src/common/services/cache-optimization.service.spec.ts  (0 test)

â¯â¯â¯â¯â¯â¯ Failed Suites 17 â¯â¯â¯â¯â¯â¯

 FAIL  tests/e2e/customer-journey.spec.ts [ tests/e2e/customer-journey.spec.ts ]
Error: Playwright Test did not expect test.describe() to be called here.
Most common reasons include:
- You are calling test.describe() in a configuration file.
- You are calling test.describe() in a file that is imported by the configuration file.
- You have two different versions of @playwright/test. This usually happens
  when one of the dependencies in your package.json depends on @playwright/test.
 â¯ TestTypeImpl._currentSuite node_modules/@playwright/test/node_modules/playwright/lib/common/testType.js:74:13
 â¯ TestTypeImpl._describe node_modules/@playwright/test/node_modules/playwright/lib/common/testType.js:114:24
 â¯ Function.describe node_modules/@playwright/test/node_modules/playwright/lib/transform/transform.js:273:12
 â¯ tests/e2e/customer-journey.spec.ts:3:6
      1| import { test, expect } from '@playwright/test';
      2| 
      3| test.describe('Customer Journey E2E Tests', () => {
       |      ^
      4|   const baseURL = process.env.FRONTEND_URL || 'http://localhost:3000';
      5|   const apiURL = process.env.API_URL || 'http://localhost:3000/api/v1';

â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯[1/39]â¯

 FAIL  tests/unit/auth/audit.service.spec.ts [ tests/unit/auth/audit.service.spec.ts ]
ColumnTypeUndefinedError: Column type for User#email is not defined and cannot be guessed. Make sure you have turned on an "emitDecoratorMetadata": true option in tsconfig.json. Also make sure you have imported "reflect-metadata" on top of the main entry file in your application (before any entity imported).If you are using JavaScript instead of TypeScript you must explicitly provide a column type.
 â¯ src/decorator/columns/Column.ts:192:23
 â¯ __decorateClass src/database/entities/user.entity.ts:13:24
     11|   UpdateDateColumn,
     12| } from 'typeorm';
     13| import { UserProfile } from './user-profile.entity';
       |                        ^
     14| import { UserRole } from './user-role.entity';
     15| import { RefreshToken } from './refresh-token.entity';
 â¯ src/database/entities/user.entity.ts:27:3
 â¯ src/database/entities/audit-log.entity.ts:2:31

â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯[2/39]â¯

 FAIL  tests/unit/auth/auth-jwt-mfa.spec.ts [ tests/unit/auth/auth-jwt-mfa.spec.ts ]
 FAIL  tests/unit/auth/sms.service.spec.ts [ tests/unit/auth/sms.service.spec.ts ]
 FAIL  tests/unit/auth/token.service.spec.ts [ tests/unit/auth/token.service.spec.ts ]
ColumnTypeUndefinedError: Column type for User#email is not defined and cannot be guessed. Make sure you have turned on an "emitDecoratorMetadata": true option in tsconfig.json. Also make sure you have imported "reflect-metadata" on top of the main entry file in your application (before any entity imported).If you are using JavaScript instead of TypeScript you must explicitly provide a column type.
 â¯ src/decorator/columns/Column.ts:192:23
 â¯ __decorateClass src/database/entities/user.entity.ts:13:24
     11|   UpdateDateColumn,
     12| } from 'typeorm';
     13| import { UserProfile } from './user-profile.entity';
       |                        ^
     14| import { UserRole } from './user-role.entity';
     15| import { RefreshToken } from './refresh-token.entity';
 â¯ src/database/entities/user.entity.ts:27:3
 â¯ src/database/entities/mfa-secret.entity.ts:2:31

â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯[3/39]â¯

 FAIL  tests/unit/auth/auth-registration.spec.ts [ tests/unit/auth/auth-registration.spec.ts ]
 FAIL  tests/unit/auth/auth.controller.spec.ts [ tests/unit/auth/auth.controller.spec.ts ]
 FAIL  src/auth/services/auth.service.spec.ts [ src/auth/services/auth.service.spec.ts ]
ColumnTypeUndefinedError: Column type for User#email is not defined and cannot be guessed. Make sure you have turned on an "emitDecoratorMetadata": true option in tsconfig.json. Also make sure you have imported "reflect-metadata" on top of the main entry file in your application (before any entity imported).If you are using JavaScript instead of TypeScript you must explicitly provide a column type.
 â¯ src/decorator/columns/Column.ts:192:23
 â¯ __decorateClass src/database/entities/user.entity.ts:13:24
     11|   UpdateDateColumn,
     12| } from 'typeorm';
     13| import { UserProfile } from './user-profile.entity';
       |                        ^
     14| import { UserRole } from './user-role.entity';
     15| import { RefreshToken } from './refresh-token.entity';
 â¯ src/database/entities/user.entity.ts:27:3
 â¯ src/auth/services/auth.service.ts:4:31

â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯[4/39]â¯

 FAIL  tests/unit/customer/booking-lifecycle.spec.ts [ tests/unit/customer/booking-lifecycle.spec.ts ]
 FAIL  tests/unit/customer/payment-processing.spec.ts [ tests/unit/customer/payment-processing.spec.ts ]
 FAIL  tests/unit/provider/provider-booking.service.spec.ts [ tests/unit/provider/provider-booking.service.spec.ts ]
 FAIL  src/customer/services/booking.service.spec.ts [ src/customer/services/booking.service.spec.ts ]
ColumnTypeUndefinedError: Column type for User#email is not defined and cannot be guessed. Make sure you have turned on an "emitDecoratorMetadata": true option in tsconfig.json. Also make sure you have imported "reflect-metadata" on top of the main entry file in your application (before any entity imported).If you are using JavaScript instead of TypeScript you must explicitly provide a column type.
 â¯ src/decorator/columns/Column.ts:192:23
 â¯ __decorateClass src/database/entities/user.entity.ts:13:24
     11|   UpdateDateColumn,
     12| } from 'typeorm';
     13| import { UserProfile } from './user-profile.entity';
       |                        ^
     14| import { UserRole } from './user-role.entity';
     15| import { RefreshToken } from './refresh-token.entity';
 â¯ src/database/entities/user.entity.ts:27:3
 â¯ src/database/entities/booking.entity.ts:2:31

â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯[5/39]â¯

 FAIL  tests/unit/customer/search-filters.spec.ts [ tests/unit/customer/search-filters.spec.ts ]
 FAIL  tests/unit/customer/search.service.spec.ts [ tests/unit/customer/search.service.spec.ts ]
ColumnTypeUndefinedError: Column type for User#email is not defined and cannot be guessed. Make sure you have turned on an "emitDecoratorMetadata": true option in tsconfig.json. Also make sure you have imported "reflect-metadata" on top of the main entry file in your application (before any entity imported).If you are using JavaScript instead of TypeScript you must explicitly provide a column type.
 â¯ src/decorator/columns/Column.ts:192:23
 â¯ __decorateClass src/database/entities/user.entity.ts:13:24
     11|   UpdateDateColumn,
     12| } from 'typeorm';
     13| import { UserProfile } from './user-profile.entity';
       |                        ^
     14| import { UserRole } from './user-role.entity';
     15| import { RefreshToken } from './refresh-token.entity';
 â¯ src/database/entities/user.entity.ts:27:3
 â¯ src/database/entities/service-provider.entity.ts:2:31

â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯[6/39]â¯

 FAIL  src/admin/services/admin-user-management.service.spec.ts [ src/admin/services/admin-user-management.service.spec.ts ]
ColumnTypeUndefinedError: Column type for User#email is not defined and cannot be guessed. Make sure you have turned on an "emitDecoratorMetadata": true option in tsconfig.json. Also make sure you have imported "reflect-metadata" on top of the main entry file in your application (before any entity imported).If you are using JavaScript instead of TypeScript you must explicitly provide a column type.
 â¯ src/decorator/columns/Column.ts:192:23
 â¯ __decorateClass src/database/entities/user.entity.ts:13:24
     11|   UpdateDateColumn,
     12| } from 'typeorm';
     13| import { UserProfile } from './user-profile.entity';
       |                        ^
     14| import { UserRole } from './user-role.entity';
     15| import { RefreshToken } from './refresh-token.entity';
 â¯ src/database/entities/user.entity.ts:27:3
 â¯ src/admin/services/admin-user-management.service.ts:4:31

â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯[7/39]â¯

 FAIL  src/auth/services/password.service.spec.ts [ src/auth/services/password.service.spec.ts ]
ReferenceError: jest is not defined
 â¯ src/auth/services/password.service.spec.ts:6:1
      4| 
      5| // Mock bcrypt
      6| jest.mock('bcrypt');
       | ^
      7| 
      8| import * as bcrypt from 'bcrypt';

â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯[8/39]â¯

 FAIL  src/common/services/cache-optimization.service.spec.ts [ src/common/services/cache-optimization.service.spec.ts ]
ReferenceError: jest is not defined
 â¯ src/common/services/cache-optimization.service.spec.ts:7:1
      5| 
      6| // Mock ioredis
      7| jest.mock('ioredis', () => ({
       | ^
      8|   default: jest.fn().mockImplementation(() => ({
      9|     info: jest.fn().mockResolvedValue(''),

â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯[9/39]â¯

â¯â¯â¯â¯â¯â¯ Failed Tests 22 â¯â¯â¯â¯â¯â¯â¯

 FAIL  tests/unit/auth/email.service.spec.ts > EmailService > constructor > should create nodemailer transporter with correct config
 FAIL  tests/unit/auth/email.service.spec.ts > EmailService > sendVerificationEmail > should send verification email with correct parameters
 FAIL  tests/unit/auth/email.service.spec.ts > EmailService > sendVerificationEmail > should handle email sending errors
 FAIL  tests/unit/auth/email.service.spec.ts > EmailService > sendPasswordResetEmail > should send password reset email with correct parameters
 FAIL  tests/unit/auth/email.service.spec.ts > EmailService > sendWelcomeEmail > should send welcome email for customers
 FAIL  tests/unit/auth/email.service.spec.ts > EmailService > sendWelcomeEmail > should send welcome email for providers
 FAIL  tests/unit/auth/email.service.spec.ts > EmailService > sendWelcomeEmail > should send generic welcome for unknown role
 FAIL  tests/unit/auth/email.service.spec.ts > EmailService > sendBookingConfirmation > should send booking confirmation to customer
 FAIL  tests/unit/auth/email.service.spec.ts > EmailService > sendBookingConfirmation > should send booking notification to provider
 FAIL  tests/unit/auth/email.service.spec.ts > EmailService > sendBookingCancellation > should send cancellation email to customer
 FAIL  tests/unit/auth/email.service.spec.ts > EmailService > sendBookingCancellation > should send cancellation email to provider
 FAIL  tests/unit/auth/email.service.spec.ts > EmailService > sendBookingReminder > should send reminder email with correct details
 FAIL  tests/unit/auth/email.service.spec.ts > EmailService > sendPaymentReceipt > should send payment receipt email
 FAIL  tests/unit/auth/email.service.spec.ts > EmailService > sendAccountLockNotification > should send account lock notification
 FAIL  tests/unit/auth/email.service.spec.ts > EmailService > sendAccountUnlockNotification > should send account unlock notification
 FAIL  tests/unit/auth/email.service.spec.ts > EmailService > sendReviewRequest > should send review request email
 FAIL  tests/unit/auth/email.service.spec.ts > EmailService > sendProviderApprovalNotification > should send approval notification
 FAIL  tests/unit/auth/email.service.spec.ts > EmailService > sendProviderApprovalNotification > should send rejection notification
 FAIL  tests/unit/auth/email.service.spec.ts > EmailService > sendCustomEmail > should send custom email with provided content
 FAIL  tests/unit/auth/email.service.spec.ts > EmailService > sendCustomEmail > should generate text from HTML if not provided
 FAIL  tests/unit/auth/email.service.spec.ts > EmailService > error handling > should propagate transporter errors
 FAIL  tests/unit/auth/email.service.spec.ts > EmailService > error handling > should handle missing email configuration gracefully
TypeError: Cannot read properties of undefined (reading 'get')
 â¯ new EmailService src/auth/services/email.service.ts:12:41
     10| 
     11|   constructor(private readonly configService: ConfigService) {
     12|     const smtpHost = this.configService.get('SMTP_HOST');
       |                                         ^
     13|     const smtpUser = this.configService.get('SMTP_USER');
     14|     const smtpPass = this.configService.get('SMTP_PASS');
 â¯ TestingInjector.instantiateClass node_modules/@nestjs/core/injector/injector.js:373:19
 â¯ callback node_modules/@nestjs/core/injector/injector.js:65:45
 â¯ TestingInjector.resolveConstructorParams node_modules/@nestjs/core/injector/injector.js:145:24
 â¯ TestingInjector.loadInstance node_modules/@nestjs/core/injector/injector.js:70:13
 â¯ TestingInjector.loadProvider node_modules/@nestjs/core/injector/injector.js:98:9
 â¯ node_modules/@nestjs/core/injector/instance-loader.js:56:13
 â¯ TestingInstanceLoader.createInstancesOfProviders node_modules/@nestjs/core/injector/instance-loader.js:55:9
 â¯ node_modules/@nestjs/core/injector/instance-loader.js:40:13

â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯[10/39]â¯

 Test Files  18 failed (18)
      Tests  22 failed (22)
   Start at  23:22:40
   Duration  894ms (transform 170ms, setup 204ms, collect 10ms, tests 20ms, environment 0ms, prepare 32ms)

